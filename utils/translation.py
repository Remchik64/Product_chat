from googletrans import Translator
import streamlit as st

# –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫–∞
translator = Translator()

def translate_text(text):
    """–ü–µ—Ä–µ–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Ä—É—Å—Å–∫–∏–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–º —è–∑—ã–∫–∞–º–∏"""
    if not text or not isinstance(text, str):
        return text

    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫ —Ç–µ–∫—Å—Ç–∞
        detected = translator.detect(text)
        
        # –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º - –ø–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, –∏–Ω–∞—á–µ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
        target_lang = 'en' if detected.lang == 'ru' else 'ru'
        
        translation = translator.translate(text, dest=target_lang)
        if translation and hasattr(translation, 'text'):
            return translation.text
        return text
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞: {str(e)}")
        return text

def display_message_with_translation(message, message_hash, avatar, role, button_key=None):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –ø–µ—Ä–µ–≤–æ–¥–∞"""
    if button_key is None:
        button_key = f"translate_{message_hash}_{role}"
    
    translation_key = f"translation_{message_hash}"
    content = message.get("content", "")
    
    with st.chat_message(role, avatar=avatar):
        cols = st.columns([0.9, 0.05, 0.05])
        
        with cols[0]:
            message_placeholder = st.empty()
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞
            if translation_key not in st.session_state:
                st.session_state[translation_key] = {
                    "is_translated": False,
                    "translated_text": None,
                    "original_text": content
                }
            elif "original_text" not in st.session_state[translation_key]:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                st.session_state[translation_key].update({
                    "original_text": content
                })
            
            current_state = st.session_state[translation_key]
            
            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—Å—Ç
            if current_state["is_translated"]:
                if current_state["translated_text"] is None:
                    current_state["translated_text"] = translate_text(content)
                message_placeholder.markdown(current_state["translated_text"])
            else:
                message_placeholder.markdown(content)
        
        with cols[1]:
            # –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
            try:
                detected_lang = translator.detect(content).lang
                tooltip = "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π" if detected_lang == 'ru' else "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –Ω–∞ —Ä—É—Å—Å–∫–∏–π"
            except:
                tooltip = "–ü–µ—Ä–µ–≤–µ—Å—Ç–∏"
                
            if st.button("üîÑ", key=button_key, help=tooltip):
                current_state = st.session_state[translation_key]
                current_state["is_translated"] = not current_state["is_translated"]
                
                # –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥ –∏ –ø–µ—Ä–µ–≤–æ–¥ –µ—â–µ –Ω–µ —Å–¥–µ–ª–∞–Ω
                if current_state["is_translated"] and current_state["translated_text"] is None:
                    current_state["translated_text"] = translate_text(content)
                
                message_placeholder.markdown(
                    current_state["translated_text"] if current_state["is_translated"] 
                    else content
                )
        
        with cols[2]:
            # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
            if st.button("üóë", key=f"delete_{message_hash}", help="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"):
                return True
    
    return False 